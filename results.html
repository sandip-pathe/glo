<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GlowGuide | Your Results</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <style>
      .processing-step {
        opacity: 0.5;
        transition: all 0.3s ease;
      }
      .processing-step.active {
        opacity: 1;
        transform: translateX(10px);
      }
      .dot-flashing {
        display: inline-block;
        position: relative;
        width: 8px;
        height: 8px;
        border-radius: 5px;
        background-color: #8a2be2;
        color: #8a2be2;
        animation: dotFlashing 1s infinite linear;
      }
      @keyframes dotFlashing {
        0% {
          opacity: 0.2;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.2;
        }
      }
      .product-card {
        transition: all 0.3s ease;
      }
      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(138, 43, 226, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="quiz-container mx-auto bg-white">
        <div class="quiz-header text-center p-4">
          <h2 class="h4 mb-0">Analyzing Your Profile</h2>
          <small>This may take 20-30 seconds</small>
        </div>

        <div class="p-4">
          <div id="processingSteps">
            <div class="processing-step mb-3" id="step1">
              <span class="dot-flashing"></span>
              Validating your inputs...
            </div>
            <div class="processing-step mb-3" id="step2">
              <span class="dot-flashing"></span>
              Analyzing skin image (if provided)...
            </div>
            <div class="processing-step mb-3" id="step3">
              <span class="dot-flashing"></span>
              Consulting with dermatology AI...
            </div>
            <div class="processing-step mb-3" id="step4">
              <span class="dot-flashing"></span>
              Curating personalized recommendations...
            </div>
          </div>

          <div id="results" class="row g-4 mt-4 d-none">
            <!-- Product cards will be inserted here -->
          </div>

          <div id="errorAlert" class="alert alert-danger d-none mt-4"></div>
        </div>
      </div>
    </div>

    <script>
      let imageAnalysisCount = parseInt(
        localStorage.getItem("imageAnalysisCount") || "0"
      );

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          activateStep("step1");

          const formData = JSON.parse(
            sessionStorage.getItem("glowGuideFormData")
          );
          console.log("Form Data:", formData);

          if (!formData || !formData.skinType || !formData.concern) {
            throw new Error("Invalid quiz data - please start over");
          }

          activateStep("step2");
          let skinAnalysis = null;

          if (formData.useAI && formData.skinImage) {
            try {
              if (imageAnalysisCount >= 5) {
                showMessage(
                  "Daily image analysis limit reached - using standard recommendations"
                );
              } else {
                const response = await fetch(
                  "/.netlify/functions/analyzeSkinImage",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ skinImage: formData.skinImage }),
                  }
                );

                if (!response.ok) throw new Error("Failed to analyze image");

                skinAnalysis = await response.json();
                console.log("Skin Analysis:", skinAnalysis);
                imageAnalysisCount++;
                localStorage.setItem("imageAnalysisCount", imageAnalysisCount);
              }
            } catch (imageError) {
              console.error("Image analysis error:", imageError);
              showMessage(
                "Image analysis unavailable - continuing with standard recommendations"
              );
            }
          }

          activateStep("step3");
          await new Promise((resolve) => setTimeout(resolve, 2000));

          activateStep("step4");

          const userProfile = {
            skinType: formData.skinType,
            primaryConcern: formData.concern,
            budget: formData.budget,
            environment: formData.environment,
            skinImage: skinAnalysis ? JSON.stringify(skinAnalysis) : null,
          };

          const recommendationsResponse = await fetch(
            "/.netlify/functions/fetchProductRecommendations",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ userProfile }),
            }
          );

          if (!recommendationsResponse.ok)
            throw new Error("Failed to fetch recommendations");

          const result = await recommendationsResponse.json();
          console.log("Product Recommendations:", result);

          document.getElementById("processingSteps").classList.add("d-none");

          // Fix: `result.products` instead of `recommendations.products`
          renderProducts(result.products);
        } catch (err) {
          console.error("Processing error:", err);
          showError(err.message || "Something went wrong!");
        }
      });

      function activateStep(stepId) {
        document.querySelectorAll(".processing-step").forEach((step) => {
          step.classList.remove("active");
        });
        document.getElementById(stepId).classList.add("active");
      }

      function renderProducts(products) {
        const container = document.getElementById("results");
        container.classList.remove("d-none");

        container.innerHTML = products
          .map(
            (product) => `
                <div class="col-md-6">
                    <div class="card product-card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5 class="card-title">${product.name}</h5>
                                <span class="text-primary">${
                                  product.price
                                }</span>
                            </div>
                            <p class="text-muted small">${
                              product.description
                            }</p>
                            <div class="mt-2">
                                <small class="text-muted">Key ingredients: ${product.keyIngredients.join(
                                  ", "
                                )}</small>
                            </div>
                            <a href="${
                              product.affiliateLink
                            }" target="_blank" class="btn btn-primary mt-3 w-100">
                                Buy Now on ${product.source || "Our Partner"}
                            </a>
                            ${
                              product.whyMatch
                                ? `<p class="text-info small mt-2">${product.whyMatch}</p>`
                                : ""
                            }
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function showError(message) {
        document.getElementById("processingSteps").classList.add("d-none");
        const alert = document.getElementById("errorAlert");
        alert.classList.remove("d-none");
        alert.textContent = message;
      }

      function showMessage(message) {
        const alert = document.createElement("div");
        alert.className = "alert alert-info mt-3";
        alert.textContent = message;
        document.querySelector(".quiz-container .p-4").appendChild(alert);
      }
    </script>
  </body>
</html>
